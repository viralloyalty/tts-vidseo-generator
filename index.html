<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Subtitle Video Generator</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¬</text></svg>">
    <!-- COOP/COEP Service Worker to enable SharedArrayBuffer for FFmpeg -->
    <script src="coi-serviceworker.js"></script>
    <!-- Tailwind Play CDN â€” fine for local/internal tools, no build step needed -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <!-- JSZip for batch downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FFmpeg.wasm â€” served locally so worker.js resolves to same-origin -->
    <script src="ffmpeg.js"></script>
    <style>
        @font-face {
            font-family: 'Arial';
            src: url('Arial-Bold.ttf') format('truetype');
            font-weight: normal;
        }

        @font-face {
            font-family: 'Georgia';
            src: url('Georgia-Bold.ttf') format('truetype');
            font-weight: normal;
        }

        @font-face {
            font-family: 'Verdana';
            src: url('Verdana-Bold.ttf') format('truetype');
            font-weight: normal;
        }

        .custom-loader {
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* preview box styling */
        #previewBox {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 360px;
            background: #000;
            margin: 1rem auto;
            overflow: hidden;
        }

        #previewSubtitle {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 48px;
            font-family: var(--subtitle-font, 'Arial');
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.8);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800 p-4 md:p-8 font-sans">
    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-blue-600 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold mb-2">Dual-Language TTS Subtitle Video Generator</h1>
                <p class="text-blue-100">Convert bilingual paragraphs into transparent QuickTime videos (.mov) with
                    text-to-speech audio and auto-generated subtitles.</p>
            </div>
            <button id="generateAllGlobalBtn" disabled
                class="bg-green-500 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-200 text-lg flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Generate All Blocks
            </button>
        </div>

        <div class="p-6">
            <div id="setupAlert"
                class="mb-6 p-4 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg flex items-start gap-3">
                <div class="custom-loader mt-1"></div>
                <div>
                    <strong class="block font-semibold">Initializing systems...</strong>
                    <span id="setupStatusText" class="text-sm">Loading FFmpeg.wasm and models. This might take a
                        moment.</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- English Input -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">English Script (Kokoro-82M)</label>
                    <textarea id="scriptInputEn" rows="12"
                        class="w-full border-gray-300 rounded-lg shadow-sm p-4 border focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 transition-colors resize-y font-mono text-sm leading-relaxed"
                        placeholder="Line 1: Once upon a time in a digital world...

Line 2: There lived a powerful AI language model..."></textarea>
                </div>

                <!-- Spanish Input -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Spanish Script
                        (Xenova/mms-tts-spa)</label>
                    <textarea id="scriptInputEs" rows="12"
                        class="w-full border-gray-300 rounded-lg shadow-sm p-4 border focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 transition-colors resize-y font-mono text-sm leading-relaxed"
                        placeholder="Line 1: HabÃ­a una vez en un mundo digital...

Line 2: VivÃ­a un poderoso modelo de lenguaje de IA..."></textarea>
                </div>
            </div>

            <!-- Customization Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="md:col-span-3">
                    <h3 class="text-lg font-bold text-gray-800 mb-1">Subtitle Settings</h3>
                    <p class="text-sm text-gray-500 mb-4">Adjust styling and preview your subtitles before generating.
                        (These settings apply to all generated videos)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">Font Style</label>
                    <select id="fontSelect" class="w-full border-gray-300 rounded shadow-sm focus:ring-blue-500 p-2">
                        <option value="Arial" selected>Arial</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">Drop Shadow Size</label>
                    <input type="range" id="shadowRange" min="0" max="10" value="3" class="w-full accent-blue-600" />
                    <div class="flex justify-between text-xs text-gray-400 mt-1"><span>None</span><span>Max</span></div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-700">Vertical Position (From Bottom)</label>
                    <input type="range" id="yPosRange" min="5" max="95" value="33" class="w-full accent-blue-600" />
                    <div class="flex justify-between text-xs text-gray-400 mt-1"><span>Bottom</span><span>Top</span>
                    </div>
                </div>
                <!-- Preview Box -->
                <div class="md:col-span-3" id="previewBox">
                    <div id="previewSubtitle">Once upon a time in a digital world...</div>
                </div>
            </div>

            <button id="parseBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-200 transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed mb-8">
                Split into Bilingual Paragraph Blocks
            </button>

            <div class="flex justify-between items-end mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800">Paragraphs Editor</h2>
                <button id="downloadAllBtn"
                    class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow transition duration-200 text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download Compiled ZIP
                </button>
            </div>

            <div id="blocksContainer" class="space-y-6">
                <p
                    class="text-gray-500 text-center py-8 italic bg-gray-50 rounded-lg border border-dashed border-gray-300">
                    Enter both scripts and click "Split into Bilingual Paragraph Blocks" to begin.</p>
            </div>
        </div>
    </div>

    <!-- Transformers.js & Kokoro imported as an ES module -->
    <script type="module">
        import { KokoroTTS } from 'https://cdn.jsdelivr.net/npm/kokoro-js@1.2.1/+esm';
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';

        // Disable local models for browser use
        env.allowLocalModels = false;
        env.useBrowserCache = true;

        const { FFmpeg } = window.FFmpegWASM;
        const ffmpeg = new FFmpeg();
        // Pipe all FFmpeg logs to the browser console for debugging
        ffmpeg.on('log', ({ type, message }) => console.log(`[ffmpeg] ${type}: ${message}`));
        let isFFmpegLoaded = false;

        let models = {
            en: null,
            es: null
        };

        const ui = {
            setupAlert: document.getElementById('setupAlert'),
            setupStatusText: document.getElementById('setupStatusText'),
            parseBtn: document.getElementById('parseBtn'),
            scriptInputEn: document.getElementById('scriptInputEn'),
            scriptInputEs: document.getElementById('scriptInputEs'),
            blocksContainer: document.getElementById('blocksContainer'),
            downloadAllBtn: document.getElementById('downloadAllBtn'),
            generateAllGlobalBtn: document.getElementById('generateAllGlobalBtn'),
            fontSelect: document.getElementById('fontSelect'),
            shadowRange: document.getElementById('shadowRange'),
            yPosRange: document.getElementById('yPosRange'),
            previewSubtitle: document.getElementById('previewSubtitle')
        };
        // Update preview when controls change
        function updatePreview() {
            const font = ui.fontSelect.value;
            const shadow = ui.shadowRange.value;
            const yPos = ui.yPosRange.value;
            ui.previewSubtitle.style.fontFamily = font;
            ui.previewSubtitle.style.textShadow = `${shadow}px ${shadow}px 0 rgba(0,0,0,0.8)`;
            ui.previewSubtitle.style.bottom = `${yPos}%`;
            ui.previewSubtitle.style.top = '';
        }
        ui.fontSelect.addEventListener('change', updatePreview);
        ui.shadowRange.addEventListener('input', updatePreview);
        ui.yPosRange.addEventListener('input', updatePreview);
        // Initialize preview
        updatePreview();

        let generatedFiles = [];

        async function initSystem() {
            try {
                // Check if SharedArrayBuffer is available
                if (typeof SharedArrayBuffer === 'undefined') {
                    throw new Error("SharedArrayBuffer is not available. Ensure you are using a secure context and COOP/COEP headers are set (coi-serviceworker should handle this if running on localhost).");
                }

                ui.setupStatusText.textContent = "Loading FFmpeg core...";
                // ffmpeg.js is served locally, so its internal worker reference (./814.ffmpeg.js)
                // resolves to http://localhost:8000/814.ffmpeg.js â€” same-origin, no SecurityError.
                // The worker can then fetch core/WASM from CDN freely under credentialless COEP.
                const baseURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd';

                await ffmpeg.load({
                    coreURL: `${baseURL}/ffmpeg-core.js`,
                    wasmURL: `${baseURL}/ffmpeg-core.wasm`,
                });

                ui.setupStatusText.textContent = "FFmpeg loaded. Loading default fonts...";

                // Fetch fonts for rendering text (served locally now)
                const fontRes = await fetch('font.ttf');
                const fontData = await fontRes.arrayBuffer();
                await ffmpeg.writeFile('font.ttf', new Uint8Array(fontData));

                // Load custom fonts into FFmpeg virtual filesystem
                const customFonts = ['Arial-Bold.ttf', 'Georgia-Bold.ttf', 'Verdana-Bold.ttf'];
                for (const f of customFonts) {
                    try {
                        const res = await fetch(f);
                        const bData = await res.arrayBuffer();
                        await ffmpeg.writeFile(f, new Uint8Array(bData));
                    } catch (e) { console.warn('Could not load font:', f, e); }
                }

                isFFmpegLoaded = true;

                ui.setupAlert.classList.replace('bg-yellow-50', 'bg-green-50');
                ui.setupAlert.classList.replace('border-yellow-200', 'border-green-200');
                ui.setupAlert.classList.replace('text-yellow-800', 'text-green-800');
                ui.setupAlert.querySelector('.custom-loader').style.display = 'none';
                ui.setupAlert.innerHTML = `<svg class="w-6 h-6 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> <div><strong class="block font-semibold">System Ready</strong><span class="text-sm">You can now generate videos.</span></div>`;

            } catch (err) {
                console.error(err);
                ui.setupAlert.classList.replace('bg-yellow-50', 'bg-red-50');
                ui.setupAlert.classList.replace('border-yellow-200', 'border-red-200');
                ui.setupAlert.classList.replace('text-yellow-800', 'text-red-800');
                ui.setupAlert.querySelector('.custom-loader').style.display = 'none';
                ui.setupStatusText.textContent = err.message || "Failed to initialize.";
            }
        }


        // Initialize immediately
        initSystem();

        ui.parseBtn.addEventListener('click', () => {
            const textEn = ui.scriptInputEn.value.trim();
            const textEs = ui.scriptInputEs.value.trim();

            if (!textEn && !textEs) return;

            // Split by empty lines
            const paragraphsEn = textEn ? textEn.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean) : [];
            const paragraphsEs = textEs ? textEs.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean) : [];

            // Find max length to create paired blocks
            const maxLen = Math.max(paragraphsEn.length, paragraphsEs.length);

            ui.blocksContainer.innerHTML = '';
            generatedFiles = [];
            ui.downloadAllBtn.classList.add('hidden');
            ui.generateAllGlobalBtn.disabled = maxLen === 0;

            for (let idx = 0; idx < maxLen; idx++) {
                const pEn = paragraphsEn[idx] || "";
                const pEs = paragraphsEs[idx] || "";

                const blockDiv = document.createElement('div');
                blockDiv.className = 'bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-4 transition duration-300 hover:shadow-md group';
                blockDiv.id = `block-${idx}`;

                // Header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex justify-between items-center border-b pb-2 mb-2';
                headerDiv.innerHTML = `<h3 class="font-bold text-gray-700">Paragraph Block ${idx + 1}</h3>`;

                // Content Grid
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';

                // English Column
                const colEn = createLanguageColumn('en', pEn, idx, 'English (Kokoro)');
                // Spanish Column
                const colEs = createLanguageColumn('es', pEs, idx, 'Spanish (MMS)');

                gridDiv.appendChild(colEn.el);
                gridDiv.appendChild(colEs.el);

                blockDiv.appendChild(headerDiv);
                blockDiv.appendChild(gridDiv);
                ui.blocksContainer.appendChild(blockDiv);

                // Store references for the global generate all button
                blockDiv.dataset.enText = pEn;
                blockDiv.dataset.esText = pEs;
                blockDiv.enControls = colEn.controls;
                blockDiv.esControls = colEs.controls;
            }
        });

        function createLanguageColumn(lang, text, idx, title) {
            const colDiv = document.createElement('div');
            colDiv.className = 'flex flex-col gap-3';

            const titleEl = document.createElement('h4');
            titleEl.className = 'text-sm font-semibold text-gray-600';
            titleEl.textContent = title;

            const textDiv = document.createElement('div');
            textDiv.className = 'flex-grow text-gray-700 text-sm leading-relaxed bg-gray-50 p-3 rounded-lg border border-gray-100 min-h-[80px]';
            textDiv.textContent = text || "(No content)";

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'flex flex-col gap-2 mt-auto pt-2';

            const statusP = document.createElement('p');
            statusP.className = 'text-xs text-gray-500 min-h-[16px] italic';

            const genBtn = document.createElement('button');
            genBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm shadow transition duration-150 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed';

            if (!text) {
                genBtn.disabled = true;
                genBtn.innerHTML = `No Text`;
            } else {
                genBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Generate ${lang.toUpperCase()}`;
            }

            const resultDiv = document.createElement('div');
            resultDiv.className = 'hidden flex-col gap-2 mt-2';

            genBtn.onclick = () => {
                if (text) processParagraph(lang, idx, text, genBtn, statusP, resultDiv);
            };

            controlsDiv.appendChild(statusP);
            controlsDiv.appendChild(genBtn);
            controlsDiv.appendChild(resultDiv);

            colDiv.appendChild(titleEl);
            colDiv.appendChild(textDiv);
            colDiv.appendChild(controlsDiv);

            return {
                el: colDiv,
                controls: { genBtn, statusP, resultDiv }
            };
        }

        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); // 1 channel
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * 2, true);

            let offset = 44;
            for (let i = 0; i < samples.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return new Uint8Array(buffer);
        }

        function formatLines(text, maxCharsPerLine = 45) {
            // A simple greedy word wrap
            const words = text.split(/\s+/);
            const lines = [];
            let currentLine = [];
            let currentLen = 0;

            for (const word of words) {
                if (currentLen + word.length + 1 > maxCharsPerLine && currentLine.length > 0) {
                    lines.push(currentLine.join(' '));
                    currentLine = [word];
                    currentLen = word.length;
                } else {
                    currentLine.push(word);
                    currentLen += word.length + (currentLine.length > 1 ? 1 : 0);
                }
            }
            if (currentLine.length > 0) {
                lines.push(currentLine.join(' '));
            }
            return lines.join('\n');
        }

        function getFilenameFromText(text, lang, index) {
            // Take first ~5 words, strip punctuation, lowercase
            const words = text.replace(/[^\w\s-]/g, '').trim().split(/\s+/).slice(0, 5).join('_').toLowerCase();
            const fallback = `paragraph_${index + 1}`;
            return `${lang}_${words || fallback}.mov`;
        }

        async function processParagraph(lang, index, text, btn, statusP, resultDiv) {
            if (!isFFmpegLoaded) {
                alert("FFmpeg is still loading or failed to load.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<div class="custom-loader border-white border-t-transparent w-4 h-4"></div> Processing...`;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                statusP.textContent = `Loading ${lang.toUpperCase()} ML model...`;
                statusP.style.display = 'block';
                resultDiv.classList.replace('flex', 'hidden');

                if (!models[lang]) {
                    if (lang === 'en') {
                        statusP.textContent = `Downloading Kokoro-82M TTS engine (approx. 180MB, only runs once)...`;
                        models[lang] = await KokoroTTS.from_pretrained("onnx-community/Kokoro-82M-v1.0-ONNX", {
                            dtype: "fp32"
                        });
                    } else {
                        statusP.textContent = `Downloading MMS-TTS-SPA engine...`;
                        models[lang] = await pipeline('text-to-speech', 'Xenova/mms-tts-spa', { quantized: true });
                    }
                }

                statusP.textContent = `Generating audio...`;

                let audioData, sampleRate;
                if (lang === 'en') {
                    let output = await models[lang].generate(text, { voice: "af_heart" });
                    if (output.audio && output.audio.data) {
                        output.audio = output.audio.data;
                    }
                    audioData = output.audio;
                    sampleRate = output.sampling_rate || 24000;
                } else {
                    const pipelineResult = await models[lang](text);
                    audioData = pipelineResult.audio;
                    sampleRate = pipelineResult.sampling_rate;
                }

                const wavData = encodeWAV(audioData, sampleRate);

                statusP.textContent = `Exporting video via FFmpeg...`;

                await ffmpeg.writeFile(`audio_${lang}.wav`, wavData);

                const outName = `output_${lang}_${index}.mov`;

                // Calculate duration and create chunked subtitles
                const durationSeconds = audioData.length / sampleRate;

                // 1. Split text into natural chunks (by punctuation or max 8 words)
                const words = text.split(/\s+/).filter(Boolean);
                let finalPhrases = [];
                let currentChunk = [];

                for (const word of words) {
                    currentChunk.push(word);
                    // Split if word ends with punctuation OR chunk reached 8 words
                    const endsWithPunc = /[.?!,;:]+$/.test(word);
                    if (endsWithPunc || currentChunk.length >= 8) {
                        finalPhrases.push(currentChunk.join(' '));
                        currentChunk = [];
                    }
                }
                if (currentChunk.length > 0) {
                    finalPhrases.push(currentChunk.join(' '));
                }

                // 2. Calculate Weights based on Characters and Punctuation Pauses
                let totalWeight = 0;
                let chunkStats = [];

                for (let i = 0; i < finalPhrases.length; i++) {
                    let phraseText = finalPhrases[i].trim();
                    if (!phraseText) continue;

                    let weight = phraseText.length; // Base weight: character count

                    // Add time penalty for TTS pause based on ending punctuation
                    if (/[.?!]+$/.test(phraseText)) {
                        weight += 15; // Wait longer for sentence end (~2-3 words worth)
                    } else if (/[,;:]+$/.test(phraseText)) {
                        weight += 7;  // Wait a bit for comma/semicolon (~1 word worth)
                    }

                    totalWeight += weight;

                    // Robust escaping for FFmpeg's filter complex
                    // We escape backslashes, colons, and commas which are separators in filters
                    const safeText = phraseText
                        .replace(/\\/g, '\\\\')
                        .replace(/'/g, "\\u0027") // Use unicode for single quote
                        .replace(/:/g, '\\:')
                        .replace(/,/g, '\\,');

                    chunkStats.push({ text: safeText, weight: weight, raw: phraseText });
                }

                console.log(`[Sync Debug] Total Duration: ${durationSeconds.toFixed(2)}s, Total Weight: ${totalWeight}`);
                console.table(chunkStats.map(c => ({
                    text: c.raw,
                    weight: c.weight,
                    percent: ((c.weight / totalWeight) * 100).toFixed(1) + '%'
                })));

                const timePerWeightUnit = durationSeconds / totalWeight;

                const fontFileMap = {
                    'Arial': 'Arial-Bold.ttf',
                    'Georgia': 'Georgia-Bold.ttf',
                    'Verdana': 'Verdana-Bold.ttf'
                };
                const selectedFont = ui.fontSelect.value;
                const shadowSize = ui.shadowRange.value;
                const yPosPercent = 1 - (ui.yPosRange.value / 100);

                let drawfilters = [];
                let currentStart = 0;

                for (let i = 0; i < chunkStats.length; i++) {
                    const chunk = chunkStats[i];
                    const chunkDuration = chunk.weight * timePerWeightUnit;
                    const end = currentStart + chunkDuration;

                    // Add some buffer to the last chunk to ensure it doesn't vanish too early
                    const enableEnd = (i === chunkStats.length - 1) ? durationSeconds + 1 : end;

                    drawfilters.push(`drawtext=fontfile=${fontFileMap[selectedFont]}:text='${chunk.text}':fontcolor=white:fontsize=48:x=(w-text_w)/2:y=h*${yPosPercent}:shadowcolor=black@0.8:shadowx=${shadowSize}:shadowy=${shadowSize}:enable='between(t,${currentStart.toFixed(3)},${enableEnd.toFixed(3)})'`);

                    currentStart = end;
                }

                const drawtextFilter = `[0:v]format=rgba,colorchannelmixer=aa=0,${drawfilters.join(',')}[v]`;

                const ret = await ffmpeg.exec([
                    '-f', 'lavfi',
                    '-i', 'color=c=black@0.0:s=1920x1080:r=30',
                    '-i', `audio_${lang}.wav`,
                    '-filter_complex', drawtextFilter,
                    '-map', '[v]',
                    '-map', '1:a',
                    '-c:v', 'qtrle',
                    '-pix_fmt', 'argb',
                    '-c:a', 'pcm_s16le',
                    '-shortest',
                    outName
                ]);

                if (ret !== 0) {
                    throw new Error(`FFmpeg failed (code ${ret}) â€” open DevTools Console for details`);
                }

                const fileData = await ffmpeg.readFile(outName);
                if (!fileData || fileData.length === 0) {
                    throw new Error('FFmpeg produced an empty file â€” open DevTools Console for details');
                }
                const blob = new Blob([fileData.buffer], { type: 'video/quicktime' });
                const url = URL.createObjectURL(blob);
                const filename = getFilenameFromText(text, lang, index);

                // Update UI to show result
                btn.style.display = 'none';
                statusP.style.display = 'none';

                resultDiv.classList.replace('hidden', 'flex');
                resultDiv.innerHTML = `
                    <div class="rounded overflow-hidden border border-gray-300 shadow-inner bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjY2NjIiAvPjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjY2NjIiAvPjwvc3ZnPg==')] bg-repeat">
                        <video src="${url}" controls class="w-full h-auto bg-black bg-opacity-20 max-h-[150px] object-contain"></video>
                    </div>
                    <a href="${url}" download="${filename}" class="mt-1 bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-semibold py-2 px-4 rounded border border-gray-300 shadow-sm text-center transition duration-150 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Save ${lang.toUpperCase()} .mov
                    </a>
                `;

                // Add to generated files and show Download All
                generatedFiles.push({ lang, index, filename, blob });

                if (generatedFiles.length > 0) {
                    ui.downloadAllBtn.classList.remove('hidden');
                }

                // Cleanup ffmpeg fs to save memory
                await ffmpeg.deleteFile(`audio_${lang}.wav`);
                await ffmpeg.deleteFile(outName);

                return true;

            } catch (err) {
                console.error(err);
                statusP.textContent = `Error: ${err.message}`;
                statusP.className = "text-xs text-red-500 font-medium min-h-[16px] break-words";

                btn.disabled = false;
                btn.innerHTML = `Retry ${lang.toUpperCase()}`;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                btn.classList.replace('bg-blue-600', 'bg-red-500');
                btn.classList.replace('hover:bg-blue-700', 'hover:bg-red-600');
                return false;
            }
        }

        ui.generateAllGlobalBtn.addEventListener('click', async () => {
            if (!isFFmpegLoaded) {
                alert("Please wait for system to initialize.");
                return;
            }

            const blocks = document.querySelectorAll('#blocksContainer > div[id^="block-"]');
            if (blocks.length === 0) return;

            const originalBtnHtml = ui.generateAllGlobalBtn.innerHTML;
            ui.generateAllGlobalBtn.innerHTML = `<div class="custom-loader border-white border-t-transparent w-5 h-5 mr-2"></div> Generating All...`;
            ui.generateAllGlobalBtn.disabled = true;
            ui.parseBtn.disabled = true;

            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                const enText = block.dataset.enText;
                const esText = block.dataset.esText;

                // Process English if it exists and hasn't been done (button still visible)
                if (enText && block.enControls.genBtn.style.display !== 'none') {
                    // Scroll into view gently
                    block.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    await processParagraph('en', i, enText, block.enControls.genBtn, block.enControls.statusP, block.enControls.resultDiv);
                }

                // Process Spanish if it exists and hasn't been done
                if (esText && block.esControls.genBtn.style.display !== 'none') {
                    block.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    await processParagraph('es', i, esText, block.esControls.genBtn, block.esControls.statusP, block.esControls.resultDiv);
                }
            }

            ui.generateAllGlobalBtn.innerHTML = originalBtnHtml;
            ui.generateAllGlobalBtn.disabled = false;
            ui.parseBtn.disabled = false;

            // Scroll back to top to show ZIP download if available
            if (generatedFiles.length > 0) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        ui.downloadAllBtn.addEventListener('click', async () => {
            if (generatedFiles.length === 0) return;

            const originalText = ui.downloadAllBtn.innerHTML;
            ui.downloadAllBtn.innerHTML = `<div class="custom-loader border-white border-t-transparent w-4 h-4 mr-2"></div> Zipping...`;
            ui.downloadAllBtn.disabled = true;

            try {
                const zip = new JSZip();

                // Add folders
                const enFolder = zip.folder("en");
                const esFolder = zip.folder("es");

                generatedFiles.forEach(f => {
                    if (f.lang === 'en') {
                        enFolder.file(f.filename, f.blob);
                    } else if (f.lang === 'es') {
                        esFolder.file(f.filename, f.blob);
                    }
                });

                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bilingual_subtitles_batch.zip';
                a.click();
            } catch (err) {
                console.error("ZIP Error", err);
                alert("Failed to create ZIP file.");
            } finally {
                ui.downloadAllBtn.innerHTML = originalText;
                ui.downloadAllBtn.disabled = false;
            }
        });

    </script>
</body>

</html>